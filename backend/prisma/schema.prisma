// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  Worker
  HR
}

enum LeaveDuration {
  Full
  HalfMorning
  HalfAfternoon
}

enum RequestStatus {
  Pending
  Approved
  Rejected
}

enum NotificationType {
  NewRequest
  Approval
  Rejection
  LateWarning
  EarlyLeaveWarning
}

model Employee {
  id              Int       @id @default(autoincrement()) @map("employee_id")
  firstName       String    @map("first_name") @db.VarChar(100)
  lastName        String    @map("last_name") @db.VarChar(100)
  email           String    @unique @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  role            Role
  joiningDate     DateTime  @map("joining_date") @db.Date
  resignationDate DateTime? @map("resignation_date") @db.Date
  isActive        Boolean   @default(true) @map("is_active")
  profileImageUrl String?   @map("profile_image_url") @db.VarChar(255)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt       DateTime? @updatedAt @map("updated_at") @db.Timestamp(0)

  leaveQuotas             LeaveQuota[]
  timeRecords             TimeRecord[]
  leaveRequestsAsEmployee LeaveRequest[] @relation("EmployeeRequests")
  leaveRequestsAsHr       LeaveRequest[] @relation("HrApprovals")
  notifications           Notification[]
  specialLeaveGrants      SpecialLeaveGrant[]
  @@map("employees")
}

model LeaveType {
  id            Int      @id @default(autoincrement()) @map("leave_type_id")
  typeName      String   @unique @map("type_name") @db.VarChar(100)
  isPaid        Boolean  @default(true) @map("is_paid")
  maxCarryOver  Decimal  @default(0.00) @map("max_carry_over") @db.Decimal(5, 2) 
  maxConsecutiveDays Int     @default(0) @map("max_consecutive_days")
  leaveQuotas   LeaveQuota[]
  leaveRequests LeaveRequest[]
  specialLeaveGrants SpecialLeaveGrant[]
  @@map("leave_types")


}



model LeaveQuota {
  id           Int      @id @default(autoincrement()) @map("quota_id")
  employeeId   Int      @map("employee_id")
  leaveTypeId  Int      @map("leave_type_id")
  year         Int      @db.Year
  totalDays    Decimal  @default(0.00) @map("total_days") @db.Decimal(5, 2)
  usedDays     Decimal  @default(0.00) @map("used_days") @db.Decimal(5, 2)
  carryOverDays Decimal @default(0.00) @map("carry_over_days") @db.Decimal(5, 2)

  employee  Employee  @relation(fields: [employeeId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, year])
  @@map("leave_quotas")
}

model TimeRecord {
  id           Int       @id @default(autoincrement()) @map("record_id")
  employeeId   Int       @map("employee_id")
  workDate     DateTime  @map("work_date") @db.Date
  checkInTime  DateTime  @map("check_in_time")
  checkOutTime DateTime? @map("check_out_time")
  isLate       Boolean   @default(false) @map("is_late")
  note         String?   @db.Text 

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, workDate]) // เพิ่ม Index สำหรับการดึงประวัติการเข้างานรายคนตามช่วงเวลา
  @@map("time_records")
}

model LeaveRequest {
  id                 Int           @id @default(autoincrement()) @map("request_id")
  employeeId         Int           @map("employee_id")
  leaveTypeId        Int           @map("leave_type_id")
  startDate          DateTime      @map("start_date") @db.Date
  endDate            DateTime      @map("end_date") @db.Date
  totalDaysRequested Decimal       @map("total_days_requested") @db.Decimal(4, 2)

  startDuration      LeaveDuration @map("start_duration")
  endDuration        LeaveDuration @map("end_duration")

  reason             String?       @db.Text
  attachmentUrl      String?       @map("attachment_url") @db.VarChar(255)
  status             RequestStatus @map("status")
  requestedAt        DateTime      @default(now()) @map("requested_at")

  approvedByHrId     Int?          @map("approved_by_hr_id")
  approvalDate       DateTime?     @map("approval_date")

  // ✅ 1. เพิ่มฟิลด์ Foreign Key เพื่อเก็บ ID ของการมอบสิทธิ์พิเศษ
  specialGrantId     Int?          @map("special_grant_id")

  // Relations
  employee      Employee      @relation("EmployeeRequests", fields: [employeeId], references: [id])
  leaveType     LeaveType     @relation(fields: [leaveTypeId], references: [id])
  approvedByHr  Employee?     @relation("HrApprovals", fields: [approvedByHrId], references: [id])

  // ✅ 2. เพิ่มความสัมพันธ์ไปยัง SpecialLeaveGrant
  specialGrant  SpecialLeaveGrant? @relation(fields: [specialGrantId], references: [id])

  isSpecialApproved  Boolean       @default(false) @map("is_special_approved")
  notifications      Notification[]

  @@index([employeeId, startDate])
  @@index([status])
  @@map("leave_requests")
}

model SpecialLeaveGrant {
  id          Int      @id @default(autoincrement())
  employeeId  Int      @map("employee_id")
  leaveTypeId Int      @map("leave_type_id")
  amount      Decimal  @db.Decimal(5, 2) // จำนวนวันที่ HR มอบให้เพิ่ม
  reason      String   @db.VarChar(255)  // เหตุผลที่ได้รับ
  expiryDate  DateTime @map("expiry_date") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  employee      Employee       @relation(fields: [employeeId], references: [id])
  leaveType     LeaveType      @relation(fields: [leaveTypeId], references: [id])
  leaveRequests LeaveRequest[] // เชื่อมกลับไปหาใบลาที่ใช้สิทธิ์นี้

  @@map("special_leave_grants")
}

model Notification {
  id               Int              @id @default(autoincrement()) @map("notification_id")
  employeeId       Int              @map("employee_id")
  notificationType NotificationType @map("notification_type")
  message          String           @db.VarChar(500)
  relatedRequestId Int?             @map("related_request_id")
  isRead           Boolean          @default(false) @map("is_read")
  createdAt        DateTime         @default(now()) @map("created_at")

  // Relations
  employee       Employee      @relation(fields: [employeeId], references: [id])
  relatedRequest LeaveRequest? @relation(fields: [relatedRequestId], references: [id])

  // ดัชนีเพื่อเพิ่มประสิทธิภาพการค้นหา
  @@index([employeeId, createdAt(sort: Desc)]) // ดึงข้อมูลล่าสุดได้เร็วขึ้น
  @@index([employeeId, isRead])                // นับจำนวนที่ยังไม่อ่านได้เร็วขึ้น
  @@map("notifications")
}

model SystemConfig {
  id           Int      @id @default(autoincrement())
  year         Int      @unique
  isClosed     Boolean  @default(false) // ถ้า true คือปิดยอดปีนี้แล้ว ห้ามรัน Carry Over อีก
  closedAt     DateTime?
  processedBy  Int?
}

model WorkConfiguration {
id              Int      @id @default(autoincrement())
  role            Role     @unique
  startHour       Int      
  startMin        Int      
  endHour         Int      
  endMin          Int      
  updatedAt       DateTime @updatedAt
  
  @@map("work_configurations") 
}

model Holiday {
  id        Int      @id @default(autoincrement())
  date      DateTime @unique // วันที่หยุด
  name      String   // ชื่อวันหยุด เช่น "วันสงกรานต์"
  isSubsidy Boolean  @default(false) // เป็นวันหยุดชดเชยหรือไม่
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
