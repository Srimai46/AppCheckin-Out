const prisma = require("../config/prisma");
const { calculateTotalDays } = require("../utils/leaveHelpers");

// ---------------------------------------------------------
// ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Worker (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
// ---------------------------------------------------------

// 1. ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
exports.getMyQuotas = async (req, res) => {
    try {
        // ‚úÖ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Timezone Asia/Bangkok ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)
        const currentYear = new Date().getFullYear();
        
        // ‚úÖ 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤
        const quotas = await prisma.leaveQuota.findMany({
            where: { 
                employeeId: Number(req.user.id), // ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Number
                year: currentYear 
            },
            include: { 
                leaveType: {
                    select: {
                        typeName: true,
                        description: true // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
                    }
                } 
            },
        });

        // ‚úÖ 3. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const result = quotas.map(q => {
            // ‡πÉ‡∏ä‡πâ Number() ‡∏´‡∏£‡∏∑‡∏≠ parseFloat() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö Decimal ‡∏à‡∏≤‡∏Å Database
            const base = Number(q.totalDays) || 0;
            const carry = Number(q.carryOverDays) || 0;
            const used = Number(q.usedDays) || 0;
            
            const totalAvailable = base + carry;
            const remaining = totalAvailable - used;

            return {
                leaveTypeId: q.leaveTypeId,
                type: q.leaveType.typeName,
                description: q.leaveType.description,
                baseQuota: base,
                carryOver: carry,
                total: totalAvailable,
                used: used,
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏•‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Logic ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô)
                remaining: remaining < 0 ? 0 : remaining, 
            };
        });

        res.json(result);
    } catch (error) {
        console.error("üî• getMyQuotas Error:", error);
        res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÑ‡∏î‡πâ" });
    }
};

// 2. ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
exports.getMyLeaves = async (req, res) => {
    try {
        const userId = Number(req.user.id);

        const leaves = await prisma.leaveRequest.findMany({
            where: { employeeId: userId },
            orderBy: { 
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ createdAt ‡∏´‡∏£‡∏∑‡∏≠ id ‡πÅ‡∏ó‡∏ô ‡∏´‡∏≤‡∏Å requestedAt ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Schema 
                // ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                createdAt: "desc" 
            },
            include: { 
                leaveType: {
                    select: {
                        typeName: true,
                    }
                } 
            },
        });

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏à‡∏±‡∏î Format ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö (Data Transformation)
        const formattedLeaves = leaves.map(leave => ({
            id: leave.id,
            type: leave.leaveType.typeName,
            startDate: leave.startDate,
            endDate: leave.endDate,
            totalDays: Number(leave.totalDaysRequested),
            status: leave.status,
            reason: leave.reason,
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡πà‡∏á URL ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö null
            attachmentUrl: leave.attachmentUrl ? leave.attachmentUrl : null,
            createdAt: leave.createdAt,
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            durationText: leave.startDuration === leave.endDuration 
                ? leave.startDuration 
                : `${leave.startDuration} - ${leave.endDuration}`
        }));

        res.json(formattedLeaves);
    } catch (error) {
        console.error("üî• getMyLeaves Error:", error);
        res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÑ‡∏î‡πâ" });
    }
};

// 3. ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà
exports.createLeaveRequest = async (req, res) => {
    try {
        const { type, startDate, endDate, reason, startDuration, endDuration } = req.body;
        const userId = Number(req.user.id); // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Type Mismatch

        const start = new Date(startDate);
        const end = new Date(endDate);
        const year = start.getFullYear();

        // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Path ‡πÑ‡∏ü‡∏•‡πå (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö Relative Path)
        const attachmentUrl = req.file ? `uploads/attachments/${req.file.filename}` : null;

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤
        const leaveType = await prisma.leaveType.findUnique({ where: { typeName: type } });
        if (!leaveType) return res.status(400).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Helper Function)
        const totalDaysRequested = calculateTotalDays(start, end, startDuration, endDuration);
        
        // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        if (leaveType.maxConsecutiveDays > 0 && totalDaysRequested > leaveType.maxConsecutiveDays) {
            return res.status(400).json({ 
                error: `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ${type} ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ${leaveType.maxConsecutiveDays} ‡∏ß‡∏±‡∏ô` 
            });
        }

        if (totalDaysRequested <= 0) {
            return res.status(400).json({ error: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤)" });
        }

        // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Transaction ---
        const result = await prisma.$transaction(async (tx) => {
            
            // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô (Overlap Check)
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Pending ‡∏´‡∏£‡∏∑‡∏≠ Approved ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            const overlap = await tx.leaveRequest.findFirst({
                where: {
                    employeeId: userId,
                    status: { in: ["Pending", "Approved"] },
                    AND: [
                        { startDate: { lte: end } },
                        { endDate: { gte: start } }
                    ]
                },
            });

            if (overlap) throw new Error("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)");

            // 5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏≤
            const quota = await tx.leaveQuota.findUnique({
                where: { 
                    employeeId_leaveTypeId_year: { 
                        employeeId: userId, 
                        leaveTypeId: leaveType.id, 
                        year: year 
                    } 
                }
            });

            if (!quota) throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year}`);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: (‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏´‡∏•‡∏±‡∏Å + ‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¢‡∏Å‡∏°‡∏≤) - ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
            const remaining = Number(quota.totalDays) + Number(quota.carryOverDays || 0) - Number(quota.usedDays);
            
            if (remaining < totalDaysRequested) {
                throw new Error(`‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining} ‡∏ß‡∏±‡∏ô, ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ${totalDaysRequested} ‡∏ß‡∏±‡∏ô)`);
            }

            // 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
            return await tx.leaveRequest.create({
                data: {
                    employeeId: userId,
                    leaveTypeId: leaveType.id,
                    startDate: start,
                    endDate: end,
                    totalDaysRequested: totalDaysRequested,
                    reason: reason ? reason.trim() : null,
                    startDuration: startDuration || "Full",
                    endDuration: endDuration || "Full",
                    status: "Pending",
                    attachmentUrl: attachmentUrl, 
                },
            });
        });

        res.status(201).json({ message: "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß", data: result });

    } catch (error) {
        console.error("üî• createLeaveRequest Error:", error.message);
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô
        res.status(400).json({ error: error.message });
    }
};

// ---------------------------------------------------------
// ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á HR (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
// ---------------------------------------------------------

// 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
exports.getPendingRequests = async (req, res) => {
    try {
        // ‚úÖ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Middleware ‡∏Ç‡∏≠‡∏á Routes)
        // ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏µ authorize('HR', 'Admin') ‡∏ó‡∏µ‡πà Route ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô
        if (!["HR", "Admin"].includes(req.user.role)) {
            return res.status(403).json({ error: "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ" });
        }

        // ‚úÖ 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        const requests = await prisma.leaveRequest.findMany({
            where: { status: "Pending" },
            include: {
                employee: {
                    select: {
                        id: true,
                        firstName: true,
                        lastName: true,
                        email: true,
                        profileImageUrl: true,
                        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏≤‡∏à‡∏î‡∏∂‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ HR ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
                        role: true 
                    }
                },
                leaveType: {
                    select: {
                        typeName: true,
                        maxConsecutiveDays: true // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ HR ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    }
                },
            },
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà (asc) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö "‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô-‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô" (First-come, First-served)
            orderBy: { 
                createdAt: "asc" // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ requestedAt ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ createdAt ‡πÅ‡∏ó‡∏ô
            },
        });

        // ‚úÖ 3. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Optional: ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ Frontend ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
        const formattedRequests = requests.map(reqItem => ({
            ...reqItem,
            employeeName: `${reqItem.employee.firstName} ${reqItem.employee.lastName}`,
            totalDays: Number(reqItem.totalDaysRequested), // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Decimal ‡∏à‡∏≤‡∏Å DB
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡πà‡∏á URL ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
            attachmentUrl: reqItem.attachmentUrl ? reqItem.attachmentUrl : null
        }));

        res.status(200).json(formattedRequests);

    } catch (error) {
        console.error("üî• getPendingRequests Error:", error);
        res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ" });
    }
};

// 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
exports.getAllLeaves = async (req, res) => {
    try {
        const leaves = await prisma.leaveRequest.findMany({
            include: {
                employee: { select: { firstName: true, lastName: true, role: true } },
                leaveType: { select: { typeName: true } },
            },
            orderBy: { startDate: "desc" },
        });
        res.json(leaves.map(l => ({
            ...l,
            name: `${l.employee.firstName} ${l.employee.lastName}`,
            type: l.leaveType.typeName,
            totalDays: Number(l.totalDaysRequested)
        })));
    } catch (error) {
        res.status(500).json({ error: "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î" });
    }
};exports.getAllLeaves = async (req, res) => {
    try {
        // ‚úÖ 1. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Filter ‡∏à‡∏≤‡∏Å Query Parameters (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô)
        const { status, leaveType, start, end } = req.query;

        // ‚úÖ 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Condition ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        const where = {};
        if (status) where.status = status;
        if (leaveType) where.leaveType = { typeName: leaveType };
        if (start && end) {
            where.startDate = {
                gte: new Date(start),
                lte: new Date(end)
            };
        }

        // ‚úÖ 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
        const leaves = await prisma.leaveRequest.findMany({
            where,
            include: {
                employee: { 
                    select: { 
                        id: true, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                        firstName: true, 
                        lastName: true, 
                        role: true,
                        profileImageUrl: true // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    } 
                },
                leaveType: { 
                    select: { 
                        typeName: true 
                    } 
                },
            },
            orderBy: { startDate: "desc" },
        });

        // ‚úÖ 4. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Transformation)
        const result = leaves.map(l => ({
            id: l.id,
            employeeId: l.employee.id,
            fullName: `${l.employee.firstName} ${l.employee.lastName}`,
            profileImageUrl: l.employee.profileImageUrl,
            role: l.employee.role,
            leaveType: l.leaveType.typeName,
            startDate: l.startDate,
            endDate: l.endDate,
            totalDays: Number(l.totalDaysRequested), // ‚úÖ ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Number
            status: l.status,
            reason: l.reason,
            attachmentUrl: l.attachmentUrl,
            createdAt: l.createdAt
        }));

        res.status(200).json(result);

    } catch (error) {
        console.error("üî• getAllLeaves Error:", error);
        res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ" });
    }
};

// 3. ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤
exports.updateLeaveStatus = async (req, res) => {
    try {
        const { id, status, isSpecial } = req.body; 
        const hrId = req.user.id;
        const leaveId = parseInt(id);

        // 1. Validation ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
        if (!leaveId || !["Approved", "Rejected"].includes(status)) {
            return res.status(400).json({ error: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ID ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
        }

        const result = await prisma.$transaction(async (tx) => {
            // 2. ‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const request = await tx.leaveRequest.findUnique({
                where: { id: leaveId },
                include: { leaveType: true }
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ö‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô Pending ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (!request || request.status !== "Pending") {
                throw new Error("‡πÉ‡∏ö‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
            }

            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏•‡∏≤
            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ status: "Pending" ‡πÉ‡∏ô where ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Optimistic Locking)
            const updatedRequest = await tx.leaveRequest.update({
                where: { id: leaveId, status: "Pending" }, 
                data: { 
                    status, 
                    approvedByHrId: hrId, 
                    approvalDate: new Date(),
                    isSpecialApproved: status === "Approved" ? (!!isSpecial) : false
                }
            });

            // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥)
            if (status === "Approved" && !isSpecial) {
                await tx.leaveQuota.update({
                    where: {
                        employeeId_leaveTypeId_year: {
                            employeeId: request.employeeId,
                            leaveTypeId: request.leaveTypeId,
                            year: request.startDate.getFullYear()
                        }
                    },
                    data: { 
                        // ‚úÖ ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ Number ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤ Null
                        usedDays: { increment: Number(request.totalDaysRequested) } 
                    }
                });
            }

            // 5. ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notification)
            let notifyMsg = `‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤ ${request.leaveType.typeName} ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ ${status === "Approved" ? "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" : "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò"}`;
            if (status === "Approved" && isSpecial) {
                notifyMsg = `‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤ ${request.leaveType.typeName} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏≤)`;
            }

            const newNotification = await tx.notification.create({
                data: {
                    employeeId: request.employeeId,
                    notificationType: status === "Approved" ? "Approval" : "Rejection",
                    message: notifyMsg,
                    relatedRequestId: request.id,
                    isRead: false
                }
            });

            // 6. ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô
            const unreadCount = await tx.notification.count({
                where: { employeeId: request.employeeId, isRead: false }
            });

            return { updatedRequest, newNotification, unreadCount };
        });

        // 7. ‡∏™‡πà‡∏á Real-time Notification ‡∏ú‡πà‡∏≤‡∏ô Socket.io
        const io = req.app.get("io");
        if (io) {
            io.to(`user_${result.updatedRequest.employeeId}`).emit("new_notification", {
                id: result.newNotification.id,
                message: result.newNotification.message,
                type: result.newNotification.notificationType,
                relatedRequestId: result.newNotification.relatedRequestId,
                createdAt: result.newNotification.createdAt,
                unreadCount: result.unreadCount 
            });
        }

        res.json({ 
            success: true,
            message: `‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ${status === "Approved" ? "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" : "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò"}${isSpecial ? ' (‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©)' : ''} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 
            data: result.updatedRequest,
            unreadCount: result.unreadCount 
        });

    } catch (error) {
        console.error("üî• Update Leave Status Error:", error);
        // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡πÉ‡∏´‡πâ User ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
        const statusCode = error.message.includes("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞") ? 400 : 500;
        res.status(statusCode).json({ error: error.message });
    }
};


// 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
exports.updateEmployeeQuota = async (req, res) => {
    try {
        const { employeeId } = req.params; 
        const { leaveTypeId, year, totalDays } = req.body;

        // 1. Validate & Convert Data Types (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô NaN)
        const targetEmployeeId = parseInt(employeeId);
        const targetLeaveTypeId = parseInt(leaveTypeId);
        const targetYear = parseInt(year);
        const targetTotalDays = parseFloat(totalDays);

        if (isNaN(targetEmployeeId) || isNaN(targetLeaveTypeId) || isNaN(targetTotalDays)) {
            return res.status(400).json({ error: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
        }

        // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á Employee ‡πÅ‡∏•‡∏∞ LeaveType (Foreign Key Integrity)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
        const [employeeExists, leaveTypeExists] = await Promise.all([
            prisma.employee.findUnique({ where: { id: targetEmployeeId } }),
            prisma.leaveType.findUnique({ where: { id: targetLeaveTypeId } })
        ]);

        if (!employeeExists) return res.status(404).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });
        if (!leaveTypeExists) return res.status(404).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });

        // 3. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Upsert
        const result = await prisma.leaveQuota.upsert({
            where: { 
                employeeId_leaveTypeId_year: { 
                    employeeId: targetEmployeeId, 
                    leaveTypeId: targetLeaveTypeId, 
                    year: targetYear 
                } 
            },
            update: { 
                totalDays: targetTotalDays 
            },
            create: { 
                employeeId: targetEmployeeId, 
                leaveTypeId: targetLeaveTypeId, 
                year: targetYear, 
                totalDays: targetTotalDays, 
                usedDays: 0,
                carryOverDays: 0 // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            }
        });

        // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Optional - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)
        console.log(`[QUOTA_UPDATE] HR ID: ${req.user.id} updated quota for Emp ID: ${targetEmployeeId}`);

        res.json({ 
            success: true,
            message: `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ ${leaveTypeExists.typeName} ‡∏õ‡∏µ ${targetYear} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 
            data: result 
        });

    } catch (error) {
        console.error("üî• updateEmployeeQuota Error:", error);
        res.status(500).json({ error: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤" });
    }
};


// 5. ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
exports.processCarryOver = async (req, res) => {
    try {
        const { targetYear } = req.body;
        if (!targetYear) return res.status(400).json({ error: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" });

        const yearInt = parseInt(targetYear);
        const lastYear = yearInt - 1;

        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î Query)
        const oldQuotas = await prisma.leaveQuota.findMany({
            where: { year: lastYear },
            include: { leaveType: true }
        });

        if (oldQuotas.length === 0) {
            return res.status(404).json({ message: `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ ${lastYear} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•` });
        }

        // 2. ‡πÉ‡∏ä‡πâ Transaction ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        await prisma.$transaction(async (tx) => {
            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Bulk Update ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
            // ‡∏´‡∏≤‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏• ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á Chunk ‡πÅ‡∏ï‡πà‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ Promise.all ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô tx ‡πÑ‡∏î‡πâ
            
            const tasks = oldQuotas.map((quota) => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á
                const base = Number(quota.totalDays) || 0;
                const carry = Number(quota.carryOverDays) || 0;
                const used = Number(quota.usedDays) || 0;
                const maxCarry = Number(quota.leaveType.maxCarryOver) || 0;

                const remaining = (base + carry) - used;
                
                // ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏ö‡πÑ‡∏õ (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
                const carryAmount = Math.min(Math.max(remaining, 0), maxCarry);

                // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏ö‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
                // ‡πÉ‡∏ä‡πâ Upsert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Record ‡∏õ‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏±‡∏ö totalDays ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡∏≤
                return tx.leaveQuota.upsert({
                    where: { 
                        employeeId_leaveTypeId_year: { 
                            employeeId: quota.employeeId, 
                            leaveTypeId: quota.leaveTypeId, 
                            year: yearInt 
                        } 
                    },
                    update: { 
                        carryOverDays: carryAmount 
                    },
                    create: { 
                        employeeId: quota.employeeId, 
                        leaveTypeId: quota.leaveTypeId, 
                        year: yearInt, 
                        totalDays: 0, // ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Reset ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
                        carryOverDays: carryAmount, 
                        usedDays: 0 
                    }
                });
            });

            await Promise.all(tasks);
        }, {
            timeout: 30000 // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Timeout ‡πÄ‡∏õ‡πá‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞
        });

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        console.log(`[CARRY_OVER] Processed for year ${yearInt} by HR ID: ${req.user.id}`);

        res.json({ 
            success: true,
            message: `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏µ ${lastYear} ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏õ‡∏µ ${yearInt} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${oldQuotas.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)` 
        });

    } catch (error) {
        console.error("üî• processCarryOver Error:", error);
        res.status(500).json({ error: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏™‡∏∞‡∏™‡∏°: " + error.message });
    }
};


// 6. ‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
exports.grantSpecialLeave = async (req, res) => {
    try {
        const { employeeId, leaveTypeId, amount, reason, year } = req.body;
        const hrId = req.user.id; // ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á HR ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

        // 1. Validation ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
        const targetEmpId = parseInt(employeeId);
        const targetTypeId = parseInt(leaveTypeId);
        const targetAmount = parseFloat(amount);
        const targetYear = parseInt(year);

        if (isNaN(targetEmpId) || isNaN(targetTypeId) || targetAmount <= 0) {
            return res.status(400).json({ error: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0" });
        }

        const result = await prisma.$transaction(async (tx) => {
            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
            const employee = await tx.employee.findUnique({ where: { id: targetEmpId } });
            if (!employee) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");

            // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Audit Log)
            const grant = await tx.specialLeaveGrant.create({
                data: {
                    employeeId: targetEmpId,
                    leaveTypeId: targetTypeId,
                    amount: targetAmount,
                    reason: reason || "HR Granted Special Leave",
                    grantedByHrId: hrId, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ HR ‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ
                    expiryDate: new Date(`${targetYear}-12-31T23:59:59.999Z`)
                }
            });

            // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ (Upsert)
            const quota = await tx.leaveQuota.upsert({
                where: { 
                    employeeId_leaveTypeId_year: { 
                        employeeId: targetEmpId, 
                        leaveTypeId: targetTypeId, 
                        year: targetYear 
                    } 
                },
                update: { 
                    totalDays: { increment: targetAmount } 
                },
                create: { 
                    employeeId: targetEmpId, 
                    leaveTypeId: targetTypeId, 
                    year: targetYear, 
                    totalDays: targetAmount, 
                    usedDays: 0,
                    carryOverDays: 0
                }
            });

            // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Notification)
            const notification = await tx.notification.create({
                data: {
                    employeeId: targetEmpId,
                    notificationType: "Info",
                    message: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${targetAmount} ‡∏ß‡∏±‡∏ô ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å: ${reason || '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'}`,
                    isRead: false
                }
            });

            return { grant, quota, notification };
        });

        // 6. ‡∏¢‡∏¥‡∏á Socket.io ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const io = req.app.get("io");
        if (io) {
            io.to(`user_${targetEmpId}`).emit("new_notification", {
                type: "Info",
                message: result.notification.message,
                createdAt: result.notification.createdAt
            });
        }

        res.json({ 
            success: true, 
            message: "‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
            data: result.grant 
        });

    } catch (error) {
        console.error("üî• grantSpecialLeave Error:", error);
        res.status(error.message === "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" ? 404 : 500).json({ 
            error: error.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©" 
        });
    }
};